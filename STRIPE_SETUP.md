# Stripe API 設定手順

このドキュメントでは DumDumb アプリケーションで Stripe API を使用するための設定手順を説明します。

## 1. 環境変数の設定

### ユーザーサイト（dumdumb_dev）

1. `.env.example`ファイルをコピーして`.env`ファイルを作成します：

   ```bash
   cp .env.example .env
   ```

2. `.env`ファイルを編集して、Stripe テスト用 API キーを設定します：
   ```
   STRIPE_SECRET_KEY=sk_test_YOUR_TEST_SECRET_KEY
   NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_YOUR_TEST_PUBLISHABLE_KEY
   STRIPE_WEBHOOK_SECRET=whsec_YOUR_TEST_WEBHOOK_SECRET
   ```

## 2. API キーの取得方法

1. [Stripe ダッシュボード](https://dashboard.stripe.com/)にログイン
2. テストモードがアクティブであることを確認（右上の「テストデータを表示」が選択されていること）
3. 左側のメニューから「開発者 > API キー」を選択
4. 表示されている「公開可能キー」（`pk_test_`で始まる）と「シークレットキー」（`sk_test_`で始まる）をコピー
5. Webhook シークレットを取得するには:
   - 左側のメニューから「開発者 > Webhook」を選択
   - エンドポイントを作成またはクリック
   - 「署名シークレット」セクションで「シークレットを表示」をクリック

## 3. テストカード情報

クレジットカード決済のテストには以下のテストカード情報が使用できます：

- カード番号: `4242 4242 4242 4242`
- 有効期限: 将来の任意の日付（例：12/25）
- CVC: 任意の 3 桁の数字（例：123）
- 郵便番号: 任意の郵便番号（例：12345）

## 4. 注意事項

- テストモードでは実際の支払いは発生しません
- 本番環境への移行時は、本番用の API キーを使用するように環境変数を更新する必要があります
- API キーは機密情報です。Git リポジトリに`.env`ファイルをコミットしないでください
- フロントエンドコードでは`NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`のみ使用し、シークレットキーは絶対に公開しないでください

## 5. トラブルシューティング

- API キーが正しく設定されていない場合、支払い処理中にエラーが発生します
- エラーメッセージに「Stripe API の設定が不完全です」と表示される場合は、環境変数が正しく設定されているか確認してください
- 本番環境とテスト環境の API キーを混同しないようご注意ください
- 支払いテスト中に問題が発生した場合は、Stripe ダッシュボードの「イベント」や「ログ」セクションでエラー詳細を確認できます

## 6. Webhook 設定（オプション）

支払い状態の非同期通知を受け取るために Webhook を設定する場合：

1. Stripe ダッシュボードで「開発者 > Webhook」に移動
2. 「エンドポイントを追加」をクリック
3. エンドポイント URL を入力（例：`https://your-domain.com/api/webhook/stripe`）
4. イベントを選択（通常は `payment_intent.succeeded` などの支払い関連イベント）
5. 作成後、表示される「署名シークレット」を`.env`ファイルの`STRIPE_WEBHOOK_SECRET`に設定

## 7. 実装の確認

環境変数を設定した後、以下の手順で実装が正しく機能していることを確認してください：

1. アプリケーションを起動
2. チェックアウトページでアイテムを購入
3. クレジットカード情報入力フォームが表示されることを確認
4. テストカード情報を入力して決済処理
5. 決済処理が成功し、注文完了ページに遷移することを確認
6. Stripe ダッシュボードで決済が記録されていることを確認
